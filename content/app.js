importScripts("https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js");

function sendPatch(patch, buffers, msg_id) {
  self.postMessage({
    type: 'patch',
    patch: patch,
    buffers: buffers
  })
}

async function startApplication() {
  console.log("Loading pyodide!");
  self.postMessage({type: 'status', msg: 'Loading pyodide'})
  self.pyodide = await loadPyodide();
  self.pyodide.globals.set("sendPatch", sendPatch);
  console.log("Loaded!");
  await self.pyodide.loadPackage("micropip");
  const env_spec = ['https://cdn.holoviz.org/panel/wheels/bokeh-3.4.0-py3-none-any.whl', 'https://cdn.holoviz.org/panel/1.4.2/dist/wheels/panel-1.4.2-py3-none-any.whl', 'pyodide-http==0.2.1', 'hvplot', 'pandas', 'param', 'pyecharts']
  for (const pkg of env_spec) {
    let pkg_name;
    if (pkg.endsWith('.whl')) {
      pkg_name = pkg.split('/').slice(-1)[0].split('-')[0]
    } else {
      pkg_name = pkg
    }
    self.postMessage({type: 'status', msg: `Installing ${pkg_name}`})
    try {
      await self.pyodide.runPythonAsync(`
        import micropip
        await micropip.install('${pkg}');
      `);
    } catch(e) {
      console.log(e)
      self.postMessage({
	type: 'status',
	msg: `Error while installing ${pkg_name}`
      });
    }
  }
  console.log("Packages loaded!");
  self.postMessage({type: 'status', msg: 'Executing code'})
  const code = `
  \nimport asyncio\n\nfrom panel.io.pyodide import init_doc, write_doc\n\ninit_doc()\n\n#!/usr/bin/env python\n# coding: utf-8\nimport pandas as pd\nimport pyecharts.options as opts\nfrom pyecharts.charts import Graph\nfrom bokeh.models.widgets.tables import NumberFormatter, BooleanFormatter\nimport panel as pn\npn.extension(design='fast')     \npn.extension('tabulator')\npn.extension('echarts')  # ECharts\nimport hvplot.pandas\nimport param\nimport pickle \n\nlocale = 'zh_hans'\n#dfN_locale = pd.read_pickle ('dfN_zh_hans.pickle')\n#dfE_locale = pd.read_pickle ('dfE_zh_hans.pickle')\ndfE_locale = pd.read_pickle ('https://oxon8.github.io/jupyterlite/files/data/dfE_zh_hans.pickle')\ndfN_locale = pd.read_pickle ('https://oxon8.github.io/jupyterlite/files/data/dfN_zh_hans.pickle')\n\nimport urllib.request\nurl_2load = 'https://oxon8.github.io/jupyterlite/files/pyCEADs.pickle'\nlist_var_dict_reload = pickle.load(urllib.request.urlopen(url_2load))\n## unpacking for pickle\nfor k, v in list_var_dict_reload.items():\n    cmd = f"{k} = {v}"\n    exec (cmd)\n\nUI_label['zh_hans'] = { k:v for k,v in UI_label['zh'].items() }\nreg_dict_UI_joint = [":".join([k,v]) for k,v in reg_dict_UI.items()]\n\ndef convert_further_anyway(fstring_text, debug=False):\n    if "</style>" in fstring_text:\n        fstring_text_CSS_block  = fstring_text.split("</style>")[0] + "</style>"\n        fstring_text_to_process = fstring_text.split("</style>")[1] + "</style>"\n        return fstring_text_CSS_block + eval(f'f"""{fstring_text_to_process}"""')\n    else:\n        fstring_text_to_process = fstring_text\n        return eval(f'f"""{fstring_text_to_process}"""')\n# ---------------------------------------------------------------------------------\n\nIndicators_Main = list ( dfN_locale [ ~dfN_locale.ttips.isna() ].index.unique(level='Indicator') )  #Indicators_with_ttips\nIndicators_Secondary = [x for x in sel_indicators_list[locale] if x not in Indicators_Main]\n\n# ## preparations for class CEADsExplorer\nN_indicators_available, N_indicators  = len(sel_indicators_list[locale]), len(all_indicators_list[locale])\n\ndef generate_bokeh_formatters (columns_fmtstr,  d_trans=d_trans, locale=locale):\n    bokeh_formatters = { d_trans[locale][k]: NumberFormatter(format=format_str) for k, format_str in columns_fmtstr.items() }\n    return bokeh_formatters\n\ncol_fmt_dict = {"value":'0,0.000',"perc":'0.00%',"pctl":'0.00%'}\ncol_fmt_dict_bokeh = generate_bokeh_formatters(col_fmt_dict)\n# to be used at  pn.widgets.Tabulator(TBL, formatters=col_fmt_dict_bokeh, ...\n\ndfE_locale.loc[:,'IfIntra']=dfE_locale.loc[:,'IfIntra'].astype(str).map(d_trans[locale])\n\n# ## class CEADsExplorer\nclass CEADsExplorer(param.Parameterized):\n    ## Data directly initiated and load\n    sel_reg_localeJ = param.Selector(objects=reg_dict_UI_joint )#reg_all [locale] )   \n    sel_year_locale = param.Selector(objects=year_all [locale]) \n    sel_indicator_main      = param.Selector(objects=Indicators_Main)\n    sel_indicator_secondary = param.Selector(objects=Indicators_Secondary)\n    sel_indicator_tertiary  = param.Selector(objects=sel_indicators_list[locale])  \n    # class atrributes: dfN; dfE; sel_reg_localeJ; sel_year_locale; sel_indicator_main   all param!\n    ## Data directly initiated and load\n    dfN = param.DataFrame(dfN_locale.sort_index() )  # wrapped with param\n    dfE = param.DataFrame(dfE_locale.sort_index() )  # wrapped with param\n    \n    # define action model \n    # TBA: tabulator selection   #   selectable = 'checkbox', selection = []\n    def translate_df_columns (self, df, d_trans=d_trans, locale=locale):\n        return (df.rename (columns=d_trans[locale]))\n    def widget_Tabulator_wrapper (self, df, NorE = "N"):\n        if NorE == "N":\n            tabulator_filters = {\n                '\u8282\u70b9': {'type': 'list', 'func': 'in', 'valuesLookup': True, 'sort': 'asc', 'multiselect': True},\n                '\u503c':  {'type': 'number', 'func': '>=', 'placeholder': '\u8f93\u5165\u6700\u5c0f\u503c\u8fc7\u6ee4'},\n            }\n            TBL = pn.widgets.Tabulator (df, show_index=False, pagination='local', page_size=Tabulator_page_size, theme = "fast", \n                                    formatters=col_fmt_dict_bokeh, text_align="right",\n                                    header_filters=tabulator_filters)\n        elif NorE == "E":\n            tabulator_filters = {\n                '\u6295\u5165': {'type': 'list', 'func': 'in', 'valuesLookup': True, 'sort': 'asc', 'multiselect': True},\n                '\u4ea7\u51fa': {'type': 'list', 'func': 'in', 'valuesLookup': True, 'sort': 'asc', 'multiselect': True},\n                '\u884c\u4e1a\u5185': {'type': 'list', 'func': 'in', 'valuesLookup': True, 'multiselect': True},\n                '\u503c':  {'type': 'number', 'func': '>=', 'placeholder': '\u8f93\u5165\u6700\u5c0f\u503c\u8fc7\u6ee4'},\n            }\n            TBL = pn.widgets.Tabulator (df, show_index=False, pagination='local', page_size=Tabulator_page_size, theme = "fast", \n                                    formatters=col_fmt_dict_bokeh, text_align="right",\n                                    header_filters=tabulator_filters )\n        return TBL\n    \n    def process_param_r (self, r):\n        try:\n            reg = r.split(':')[1]\n        except:\n            reg = r\n        return (reg)\n\n    def get_df (self, r, y, i=slice(None), n=slice(None),\n                            ei=slice(None), eo=slice(None), NorE = "N"):\n        # processing r\n        reg = self.process_param_r (r)\n        if NorE == "N":\n            df = self.dfN.loc[(reg,y,n,i),:].reset_index()\\\n                         .sort_values('value', ascending=False)\n        elif NorE == "E":\n            df = self.dfE.loc[(reg,y,ei,eo),:].reset_index()\\\n                         .sort_values('value', ascending=False)\n        return  df\n    \n    def get_df_len (self, r, y, i=slice(None), n=slice(None),\n                            ei=slice(None), eo=slice(None), NorE = "N"):\n        df = self.get_df(r=r,y=y,i=i,n=n,ei=ei,eo=eo,NorE=NorE)         \n        return  len(df)\n    \n    def get_df_with_col_translated ( self, r, y, \n                                     i=slice(None), n=slice(None), ei=slice(None), eo=slice(None),\n                                     actions=["TBL_N_remove_cols","translate"], NorE = "N"):\n        # get datasource        \n        df = self.get_df (r,y,i=i,n=n,ei=ei,eo=eo, NorE = NorE)\n        # process actions\n        if "TBL_N_remove_cols" in actions:\n            ## clean up two columns for Tabulator\n            df = df.drop(['weight','ttips'], axis=1) \n        if "TBL_E_remove_cols" in actions:\n            ## clean up one column for Tabulator\n            df = df.drop(['weight'], axis=1) \n        if "translate" in actions:\n            df = self.translate_df_columns (df)\n        return  df\n        \n    def get_TBL (self, r, y, i=slice(None), n=slice(None), ei=slice(None), eo=slice(None), NorE = "N"):\n        if NorE == "N":\n            df = self.get_df_with_col_translated (r,y,i=i,n=n,ei=ei,eo=eo, actions= ["TBL_N_remove_cols","translate"], NorE = NorE)\n            TBL = self.widget_Tabulator_wrapper (df, NorE = NorE )\n        elif NorE == "E":\n            df = self.get_df_with_col_translated (r,y,i=i,n=n,ei=ei,eo=eo, actions= ["TBL_E_remove_cols","translate"], NorE = NorE)\n            TBL = self.widget_Tabulator_wrapper (df, NorE = NorE )\n        return  TBL\n\nmyExplorer = CEADsExplorer()\n\n# ## Panel outline and design\n# ### Layout_width defined for pn.template.FastGridTemplate\nLayout_width = {"en":{"sidebar":250, "OverlayMain":790, "Echart":1000, "Selector_default":200,\n                      "Tabulator_column_width":165, 'Tabulator_column_width_IndicatorsAcross':  [200, 135, 85, 90,90, 135, 85] },\n                "zh_hans":{"sidebar":240, "OverlayMain":800, "Echart":1000, "Selector_default":200, \n                      "Tabulator_column_width":105, 'Tabulator_column_width_IndicatorsAcross':  [180, 90, 80,  90,90,  90, 80] }\n               }\n### Tabulator Size\nTabulator_page_size = 10\n\nmd_Interactivity_Tips ="""1. ***\u9f20\u6807\u60ac\u6d6e(hover)***\u7f51\u7edc**\u8282\u70b9\u53ca\u8fb9\u7f18**\uff0c\u53ef\u89c1\u5b9e\u9645\u6570\u636e\u4fe1\u606f\u3002\n2. ***\u8c03\u6574***\u4e3b\u56fe**\u89c6\u56fe\u754c\u9650**\uff0c\u8bf7\u5229\u7528\u4e3b\u56fe\u4e0b\u65b9\u7684**\u8303\u56f4\u9009\u62e9\u5668**\uff0c\u6216\u4f7f\u7528\u53f3\u65b9\u7684**\u653e\u5927\u53ca\u62d6\u62fd\u5de5\u5177**\n3. ***\u6392\u5e8f***\u9644\u8868**\u6570\u636e\u5927\u5c0f**\uff0c\u5404\u8868\u683c\u7684\u5404\u884c\u6570\u636e\u5747\u53ef\u70b9\u51fb\u6309**\u5927\u81f3\u5c0f**\u6216**\u5c0f\u81f3\u5927**\u6392\u5e8f\n4. \u5404\u4e3b\u56fe\u53ca\u9644\u8868\u5747\u53ef\u8c03\u6574\uff1a\n    * \u7a97\u53e3**\u5927\u5c0f**\uff08\u81f3\u53f3\u4e0b\u89d2\u6309\u53d6**\u8c03\u6574**\u63a7\u4ef6\uff09\n    * **\u5168\u5c4f**\u7a97\u53e3\uff08\u81f3\u53f3\u4e0a\u89d2\u6309\u53d6**\u5168\u5c4f**\u63a7\u4ef6\uff09\n    * \u7a97\u53e3**\u4f4d\u7f6e**\uff08\u81f3\u5de6\u4e0a\u89d2\u6309\u53d6**\u62d6\u62fd**\u63a7\u4ef6\uff095. \n6. ***\u8fc7\u6ee4\u6bd4\u8f83*** \u5404\u9644\u8868\u6570\u636e\uff0c\u53ef\u89c1\u5b9e\u9645\u6570\u636e\u4fe1\u606f\n---\n\u2764\ufe0f\u611f\u8c22Python\u5f00\u6e90\u6570\u636e\u53ef\u89c6\u5316\u9879\u76ee[pyecharts](https://pyecharts.org/#/zh-cn/)\u3001[Echarts](https://echarts.apache.org/zh/index.html)\u3001[Holoviz](https://holoviz.org/about.html)\u53ca\u6570\u636e\u5206\u6790\u9879\u76ee[pandas](https://pandas.pydata.org/)\u53ca [scipy](https://scipy.org/)\u3002\u2764\ufe0f\u611f\u8c22\u79d1\u7814\u9879\u76ee[\u4e2d\u56fd\u78b3\u6838\u7b97\u6570\u636e\u5e93\uff08CEADs\uff09](https://www.ceads.net.cn/)\u6570\u636e\u652f\u6301\u3002\n"""\n### Parameters actualized\n## Widgets: year, regX2, indicator\n# reg\nwidget_reg_select        = pn.widgets.Select.from_param ( myExplorer.param["sel_reg_localeJ"], \n    width=Layout_width[locale][ "Selector_default"], name=UI_label[locale]['Select region'])\nwidget_reg_autocomplete  = pn.widgets.AutocompleteInput.from_param ( myExplorer.param["sel_reg_localeJ"], \n    width=Layout_width[locale][ "Selector_default"], name=UI_label[locale]['Input region autocomplete'], case_sensitive=False, search_strategy='includes', min_characters=1,\n    placeholder='GD')\n# year\nwidget_year_slider = pn.widgets.DiscreteSlider.from_param ( myExplorer.param.sel_year_locale, \n    width=Layout_width[locale][ "Selector_default"], name=UI_label[locale]['Select year'], value=reg_all [locale][0])\n# indicator\nwidget_indicator_main_sel= pn.widgets.Select.from_param ( myExplorer.param["sel_indicator_main"], \n    width=Layout_width[locale][ "Selector_default"], name=UI_label[locale]['Select main indicator'], value=Indicators_Main[0])\nwidget_indicator_secondary_sel= pn.widgets.Select.from_param ( myExplorer.param["sel_indicator_secondary"], \n    width=Layout_width[locale][ "Selector_default"], name=UI_label[locale]['Select secondary indicator'], value=Indicators_Secondary[0])\nwidget_indicator_tertiary_sel= pn.widgets.Select.from_param ( myExplorer.param["sel_indicator_tertiary"], \n    width=Layout_width[locale][ "Selector_default"], name=UI_label[locale]['Select any indicator'], value=Indicators_Secondary[-3])\n\n# Graph\nwg_slider_gravity   = pn.widgets.FloatSlider(name=UI_label[locale]['Slider Gravity'], \n                                             width=Layout_width[locale][ "Selector_default"],\n                                             #width = int(Layout_width[locale]["Echart"] *.45),\n                                             start=0.05, end=.95, step=0.05, value=0.7)\nwg_slider_repulsion = pn.widgets.IntSlider  (name=UI_label[locale]['Slider Repulsion'], \n                                             width=Layout_width[locale][ "Selector_default"],\n                                             #width = int(Layout_width[locale]["Echart"] *.45),\n                                             start=100, end=2000, step=100, value=1700)\n\n# Widgets Bind\nTBL_E_interactive = pn.bind( myExplorer.get_TBL, \n                       r=myExplorer.param.sel_reg_localeJ, \n                       y=myExplorer.param.sel_year_locale,\n                       #ei=slice(None), eo=slice(None), \n                       NorE = "E"                            \n                     )\nTBL_N_interactive_01 = pn.bind( myExplorer.get_TBL, \n                       r=myExplorer.param.sel_reg_localeJ, \n                       y=myExplorer.param.sel_year_locale,\n                       i=myExplorer.param.sel_indicator_main,\n                     )\nTBL_N_interactive_02 = pn.bind( myExplorer.get_TBL, \n                       r=myExplorer.param.sel_reg_localeJ, \n                       y=myExplorer.param.sel_year_locale,\n                       i=myExplorer.param.sel_indicator_secondary,\n                     )\nTBL_N_interactive_03 = pn.bind( myExplorer.get_TBL, \n                       r=myExplorer.param.sel_reg_localeJ, \n                       y=myExplorer.param.sel_year_locale,\n                       i=myExplorer.param.sel_indicator_tertiary,\n                     )\n\npn_sidebar = pn.Column( UI_label[locale]["### Explore a year and place"],\n                        widget_year_slider, widget_reg_select, widget_reg_autocomplete, \n                        pn.layout.Divider(),\n                        UI_label[locale]["### Focus a main indicator"],\n                        widget_indicator_main_sel,\n                        pn.layout.Divider(),\n                        UI_label[locale]["### Adjust the network"],\n                        pn.pane.Str(UI_label[locale]["Visualization parameters"]),\n                        wg_slider_gravity, wg_slider_repulsion, \n                        pn.Accordion( objects = [ pn.pane.Markdown (md_Interactivity_Tips, name=UI_label[locale]["Interactivity Tips"])] ),\n  margin = 0,\n)\n\n##### Widget Tabs:  CSS styles\nraw_css_custom_tabs = """\n.bk-header {\n    font-size: 18pt;\n}\n.bk-tab.bk-active {\n    color:#4d4d4d;\n    border-color: #002147 !important;\n    border-bottom-width: 7px;\n}\n:host .bk-tab:nth-of-type(1) {\n    background-color: #fdc086 !important;\n}\n:host .bk-tab:nth-of-type(2) {\n    background-color: #beaed4 !important;\n}\n"""\nraw_css_custom_tabs_Node = """\n.bk-header {\n    font-size: 16pt;\n}\n:host(.bk-above) .bk-tab{\n    min-width: 220px;\n}\n.bk-tab.bk-active {\n    color:#4d4d4d;\n    border-color: #002147 !important;\n    border-bottom-width: 3px;\n}\n:host .bk-tab:nth-of-type(1) {\n    background-color: #9bbf7c !important;\n}\n:host .bk-tab:nth-of-type(2) {\n    background-color: #b8d9d4 !important;\n}\n:host .bk-tab:nth-of-type(3) {\n   background-color: #d3e1f2 !important;\n}\n"""\n### pn_Node\npn_Node_tabs = pn.Tabs( (UI_label[locale]['Main'], TBL_N_interactive_01),\n                         (UI_label[locale]['Secondary'], TBL_N_interactive_02),\n                         (UI_label[locale]['Any'], TBL_N_interactive_03),\n                        stylesheets=[raw_css_custom_tabs_Node],\n) # CSS raw_css_custom_tabs_Node used\npn_Node = pn.Column( \n    pn.Row( convert_further_anyway(UI_label[locale]["fTab Node Description"])  ),\n    pn.Row( widget_indicator_main_sel, widget_indicator_secondary_sel, widget_indicator_tertiary_sel),\n    pn_Node_tabs\n)\n\nTBL_E_interactive_len = pn.bind( myExplorer.get_df_len, \n                       r=myExplorer.param.sel_reg_localeJ, \n                       y=myExplorer.param.sel_year_locale,\n                       #ei=slice(None), eo=slice(None), \n                       NorE = "E"                            \n                     )\n\n### pn_Edge\npn_Edge = pn.Column( \n    pn.Row( pn.pane.Str(UI_label[locale]["fTab Edge Description"]), TBL_E_interactive_len ),\n    TBL_E_interactive\n) \n## Putting pn_Edge and pn_Node into another Tab\npn_tabs_primary = pn.Tabs(\n    (UI_label[locale]["Node"], pn_Node),\n    (UI_label[locale]["Edge"], pn_Edge),\n    stylesheets=[raw_css_custom_tabs],\n)\n\ndef gen_Network_Graph (r, y, i, repulsion, gravity):\n    GdfN = myExplorer.get_df ( r=r, y=y, i=i).dropna() # remove any nodes with no weight values\n    GdfN.loc[:,'ttips'] = GdfN.loc[:,'ttips'].str.replace('\\n', '<br/>')\n    GdfE = myExplorer.get_df ( r=r, y=y, NorE = "E")\n\n    # Echart_nodes\n    Echart_nodes = [\n        opts.GraphNode( name=row['Node'], \n                        value=row['value'],\n                        symbol_size=row['weight'],\n                        tooltip_opts=opts.TooltipOpts(formatter=row['ttips']),\n                        itemstyle_opts=opts.ItemStyleOpts(color=d_color[locale][row['Node']]),\n                        label_opts=opts.LabelOpts(color="#F09D00", font_size=8+int(20*row['weight'])/75),\n                      )\n    for ind, row in GdfN.reset_index().iterrows() ]\n    # Echart_edges\n    Echart_edges = [\n        opts.GraphLink( source=row["Input"], target=row["Output"], value=row["value"], \n                        linestyle_opts=opts.LineStyleOpts(width=row["weight"], curve=0.33, opacity=0.25),                    \n                      )\n    for ind, row in GdfE.reset_index().iterrows() ]  \n    _plot_title_ = f"\u4ea7\u4e1a\u6295\u5165\u4ea7\u51fa\u7f51\u7edc\\n({r}, {y}, {i})"#"Input-Output Network of Industries"\n\n    try:\n        label_opts = opts.LabelOpts (font_size=16, rotate=0, text_border_width=3, text_border_color='black', text_shadow_color = "whitesmoke", text_shadow_blur = .1, text_shadow_offset_x = .2, text_shadow_offset_y =.2)  # pending upgrade for pyecharts\n    except:\n        label_opts = opts.LabelOpts (font_size=16, rotate=0)\n        \n    Echart_Graph = ( Graph().add(\n        series_name=f"({r}, {y})",\n        nodes=Echart_nodes, links=Echart_edges,\n        layout="force", #"circular"\n        repulsion=repulsion, gravity=gravity,\n        edge_length=[10,50],\n        is_roam=True, is_focusnode=True, is_draggable=True,\n        label_opts = opts.LabelOpts(is_show=True),\n        tooltip_opts = opts.TooltipOpts(formatter='{b}: <br />{c}'),      )\\\n        .set_series_opts( label_opts = label_opts)\\\n        .set_global_opts( title_opts = opts.TitleOpts(title=_plot_title_) )\\\n    )\n    return Echart_Graph\n\n## Getting Interactive Graph and Putting it in the Panel\nEchart_Graph_inter = pn.bind( gen_Network_Graph, \n                               myExplorer.param.sel_reg_localeJ, myExplorer.param.sel_year_locale, myExplorer.param.sel_indicator_main,\n                               wg_slider_repulsion, wg_slider_gravity)\n## Layout: Use panel container\npn_Echart_Graph = pn.Row ( pn.pane.ECharts( Echart_Graph_inter, width=Layout_width[locale]["Echart"], height=850),\n                           pn_sidebar\n                         )\n                  \n### Tempalte_Param\n### template_param to be used in pn.template.FastGridTemplate\nDashboardTitle = UI_label[locale]["DashboardTitle"]\n\ntemplate_param= dict(\n    title = DashboardTitle,\n    main_max_width= "1000px",\n    theme="dark",\n    theme_toggle=False,    \n    sidebar_width = Layout_width[locale]["sidebar"],\n    sidebar = pn_sidebar,\n    sidebar_footer = f"""<fast-breadcrumb><fast-breadcrumb-item href="https://oxon8.netlify.app">\xa9 2024 Oxford Roadmapping </fast-breadcrumb-item>\n    <fast-breadcrumb-item href="https://creativecommons.org/licenses/by-nc-nd/4.0">CC BY NC ND 4.0</fast-breadcrumb-item>\n    <fast-breadcrumb-item href="{UI_label[locale]['url_prj-visNetZero']}">visNetZero</fast-breadcrumb-item></fast-breadcrumb>""",\n    header_background="#002147", # Oxford blue color https://www.colorxs.com/palette/hex/002147-a3ced9-dae5f2\n    accent_base_color="#DAA520", # https://panel.holoviz.org/reference/templates/FastGridTemplate.html\n    prevent_collision=False,\n    meta_description = DashboardTitle + " by Oxford Roadmapping",\n    meta_keywords = "China; decarbonization; carbon emission; net zero; roadmapping;",\n    meta_author = "Han-Teng Liao",\n    logo ="https://oxfordroadmap.github.io/oxon8/icon.svg",\n    favicon = "https://oxfordroadmap.github.io/oxon8/favicon.ico",\n    site_url = "https://oxon8.github.io/jupyterlite/",\n    base_url = "https://oxon8.github.io/jupyterlite/files/",\n)\n"""\n    logo ="https://oxon8.netlify.app/icon.svg",#"https://oxon8.netlify.app/favicon.ico",\n    favicon = "https://oxon8.netlify.app/favicon.ico",\n    site_url = "https://oxon8.netlify.app/",\n    base_url = "https://oxon8.netlify.app/project/prj-visCEADs/",\n"""\n\n### PNtemplate Constructed using  pn.template.FastGridTemplate  \nif "zh" in locale:\n    PNtemplate = pn.template.FastGridTemplate(\n        font_url = 'https://fonts.loli.net/css?family=Open+Sans',\n        **template_param\n    )\nelse:\n    PNtemplate = pn.template.FastGridTemplate(\n        **template_param\n    )\n### Panel alltogether\nPNtemplate.main [0:3,0:12] = pn_Echart_Graph\nPNtemplate.main [3:7,0:12] = pn_tabs_primary\nPNtemplate.servable()\n\n\nawait write_doc()
  `

  try {
    const [docs_json, render_items, root_ids] = await self.pyodide.runPythonAsync(code)
    self.postMessage({
      type: 'render',
      docs_json: docs_json,
      render_items: render_items,
      root_ids: root_ids
    })
  } catch(e) {
    const traceback = `${e}`
    const tblines = traceback.split('\n')
    self.postMessage({
      type: 'status',
      msg: tblines[tblines.length-2]
    });
    throw e
  }
}

self.onmessage = async (event) => {
  const msg = event.data
  if (msg.type === 'rendered') {
    self.pyodide.runPythonAsync(`
    from panel.io.state import state
    from panel.io.pyodide import _link_docs_worker

    _link_docs_worker(state.curdoc, sendPatch, setter='js')
    `)
  } else if (msg.type === 'patch') {
    self.pyodide.globals.set('patch', msg.patch)
    self.pyodide.runPythonAsync(`
    from panel.io.pyodide import _convert_json_patch
    state.curdoc.apply_json_patch(_convert_json_patch(patch), setter='js')
    `)
    self.postMessage({type: 'idle'})
  } else if (msg.type === 'location') {
    self.pyodide.globals.set('location', msg.location)
    self.pyodide.runPythonAsync(`
    import json
    from panel.io.state import state
    from panel.util import edit_readonly
    if state.location:
        loc_data = json.loads(location)
        with edit_readonly(state.location):
            state.location.param.update({
                k: v for k, v in loc_data.items() if k in state.location.param
            })
    `)
  }
}

startApplication()